---
title: "GMRI Grants Summary - `r format(Sys.Date(), '%B %d, %Y')`"
format:
  html:
    toc: true
    toc-depth: 2
    df-print: paged
    theme: flatly
    code-fold: true
    title-block-banner: false
    title-block: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(DT)
```

```{r, echo = FALSE, include  = FALSE}
# Load the most recent grants CSV
files <- list.files(here::here(), pattern = "^GMRI_Grants.csv$", full.names = TRUE)
latest_file <- sort(files, decreasing = TRUE)[1]

grants <- read_csv(latest_file)

grants_out <- grants %>%
  arrange(Deadline) %>%
  select(Agency, Title, Deadline, Posted, AdditionalInfoURL) %>%
  mutate(
    Title = paste0("[", Title, "](", AdditionalInfoURL, ")"),
    Recent = if_else(Posted >= Sys.Date() - 7,
                     '<span style="color:white; background-color:#28a745; padding:2px 6px; border-radius:4px;">New</span>',
                     "")
  ) %>%
  select(Agency, Title, Recent, Deadline, Posted, AdditionalInfoURL) 

# Fix date formats first
grants <- grants %>%
  mutate(
    Posted = mdy(Posted),     # Use mdy, ymd, or dmy as needed
    Deadline = mdy(Deadline)
  )

# Build interactive table
grants_out <- grants %>%
  arrange(Deadline) %>%
  mutate(
    Title = paste0("<a href='", AdditionalInfoURL, "' target='_blank'>", Title, "</a>"),
    Deadline = format(Deadline, "%b %d, %Y"),
    Posted = format(Posted, "%b %d, %Y"),
    Recent = if_else(
      Posted >= Sys.Date() - 7,
      '<span style="color:white; background-color:#28a745; padding:2px 6px; border-radius:4px;">New</span>',
      ""
    )
  ) %>%
  select(Agency, Title, Recent, Deadline, Posted)

# Only filter by Agency
datatable(
  grants_out,
  escape = FALSE,
  options = list(
    pageLength = 10,
    autoWidth = TRUE,
    columnDefs = list(
      list(targets = c(1, 2, 3, 4), searchable = FALSE) # only Agency is searchable
    )
  ),
  filter = "top"
)
```

```{r}
grants_out
```
