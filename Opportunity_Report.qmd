---
title: "GMRI Grants Summary - `r format(Sys.Date(), '%B %d, %Y')`"
format:
  html:
    encoding: UTF-8
    toc: true
    toc-depth: 2
    df-print: paged
    theme: flatly
    code-fold: true
    title-block-banner: false
    title-block: false
  pdf:
    toc: true
    number-sections: false
    documentclass: article
    latex-engine: xelatex
    keep-tex: false
    fig-width: 6
    fig-height: 4
    df-print: kable
---

```{css, echo=FALSE}
.navbar, .navbar-default {
  display: none !important;
}
body {
  padding-top: 0 !important;
}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(knitr)
library(kableExtra)

link_color <- "#0047AB"  # Royal blue
```

```{r, echo = FALSE, include  = FALSE}
# Load the most recent grants CSV
files <- list.files(here::here(), pattern = "^GMRI_Grants.csv$", full.names = TRUE)
latest_file <- sort(files, decreasing = TRUE)[1]

grants <- read_csv(latest_file)

# Create the formatted table

# Build your table data
grants_out <- grants %>%
  mutate(
    Title = paste0(
      "<a href='", AdditionalInfoURL, "' style='color:#0047AB;'>", Title, "</a>"
    ),
    Deadline = as.Date(Deadline),
    Posted = as.Date(Posted),
    IsNew = if_else(Posted >= Sys.Date() - 7, 1, 0),
    New = if_else(IsNew == 1, "ðŸŸ¢", ""),
    
    # Helper columns for sorting
    Posted_for_sort = if_else(IsNew == 1, Posted, as.Date(NA)),
    Deadline_for_sort = if_else(IsNew == 0, Deadline, as.Date(NA))
  ) %>%
  select(Agency, Title, New, Deadline, Posted, IsNew, Posted_for_sort, Deadline_for_sort) %>%
  arrange(
    desc(IsNew),          # Group new first
    desc(Posted_for_sort), # Within new: most recent Posted first
    Deadline_for_sort      # Within old: earliest Deadline first
  ) %>%
  mutate(
    Deadline = format(Deadline, "%b %d, %Y"),
    Posted = format(Posted, "%b %d, %Y")
  ) %>%
  select(-Posted_for_sort, -Deadline_for_sort)  # clean up helper columns

# Identify break point (first old item)
break_index <- max(which(grants_out$IsNew == 1)) + 1

# Insert a blank separator row with dashes or just empty cells
break_row <- tibble(
  Agency = "", 
  Title = "<hr style='border: none; border-top: 2px solid #444;'>", 
  New = "", 
  Deadline = "", 
  Posted = "", 
  IsNew = NA
)

# Combine
grants_out <- bind_rows(
  grants_out[1:(break_index - 1), ],
  break_row,
  grants_out[break_index:nrow(grants_out), ]
) %>%
  select(-IsNew)  # Clean up for display
```

```{r}
fmt <- knitr::opts_knit$get("rmarkdown.pandoc.to")
tbl_format <- ifelse(fmt == "html", "html", "latex")

kable(grants_out, format = tbl_format, escape = (tbl_format != "html")) %>%
  kable_styling(
    bootstrap_options = if (tbl_format == "html") "striped" else NULL,
    latex_options = if (tbl_format == "latex") c("striped", "hold_position") else NULL,
    full_width = FALSE
  )
```
